{{/* 
  If the current item is the first item within sibling items, 
  the previous item should be the parent item of the current page.
  If not, we have to find the previous item within sibling items. 
  But if the found item has children, we need to seek recursively until there is no more child item. 

  Even if the result of Kind is a section, if it has no children and at the same time has content, 
  we should consider it to be working as a page.
  For example, if it has the form below: 

    ├── SomeItems
    |   ├── SomeItemA
    |   |   └── _index.en.md  
    |   |   └── _index.kr.md  
    |   ├── SomeItemB
    |   |   └── _index.en.md  
    |   |   └── _index.kr.md  
  
  Therefore, instead of the result of Kind, we need to check whether the children exist or not.

  It seems that the return statement could not be in the inner template. 
  So we have to split the recursive code part into a separate file.
*/}}

{{- $currentPage := . -}}

{{- $Result := slice -}}

{{- if eq $currentPage.Kind "home" -}}

  {{/*  if the given page is home, we cannot go further.  */}}
  {{- $Result = $Result | append $currentPage -}}

{{- else -}}
  {{/*  find the previous page within the sibling pages.  */}}
  {{- $pagesOfParentReversed := $currentPage.Parent.Pages.ByWeight.Reverse -}}    
  {{- $lastValidIndex := sub ( $pagesOfParentReversed.Len ) 1 -}}

  {{- $loopIndex := 0 -}}
  {{- $foundNextIndex := -1 -}}

  {{- range $pagesOfParentReversed -}}
    {{- $itemToCheck := . -}}
    {{- if eq $itemToCheck $currentPage -}}
      {{- if not ( eq $loopIndex $lastValidIndex ) -}}
        {{- $foundNextIndex = add $loopIndex 1 -}}
        {{ break }}
      {{- end -}}
    {{- end -}}
    {{- $loopIndex = add $loopIndex 1 -}}
  {{- end -}}

  {{- if eq $foundNextIndex -1 -}}
    {{/* It means this page is the first page within sibling pages. So, the previous item is the parent of this page. */}}
    {{- $Result = $Result | append $currentPage.Parent -}}
  {{- else -}}
    {{- $ResultCandidate := ( index $pagesOfParentReversed $foundNextIndex ) -}}
    {{- if ge $ResultCandidate.Pages.Len 1 -}}
      {{- $Result = $Result | append ( partial "navigation/depth_first_search/prev_recursive.html" $ResultCandidate  ) -}}
    {{- else -}}
      {{- $Result = $Result | append $ResultCandidate -}}
    {{- end -}}
  {{- end -}}

{{- end -}}

{{- return $Result -}}

